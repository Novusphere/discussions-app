{"ast":null,"code":"import _defineProperty from \"@babel/runtime/helpers/esm/defineProperty\";\nimport _regeneratorRuntime from \"@babel/runtime/regenerator\";\nimport _asyncToGenerator from \"@babel/runtime/helpers/esm/asyncToGenerator\";\nimport _classCallCheck from \"@babel/runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"@babel/runtime/helpers/esm/createClass\";\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(source, true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(source).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nvar fetch = require('node-fetch');\n\nimport { Api, JsonRpc } from 'eosjs';\nimport { JsSignatureProvider } from 'eosjs/dist/eosjs-jssig';\nimport { getTokens, getAccountTokens as _getAccountTokens } from \"./tokens\";\nexport var DEFAULT_EOS_NETWORK = {\n  host: 'eos.greymass.com',\n  port: 443,\n  protocol: 'https',\n  chainId: 'aca376f206b8fc25a6ed44dbdc66547c36c6c33e3a119ffbeaef943642f0e906'\n};\nexport var EOS =\n/*#__PURE__*/\nfunction () {\n  _createClass(EOS, [{\n    key: \"accountName\",\n    get: function get() {\n      return this.wallet && this.wallet.auth ? this.wallet.auth.accountName : undefined;\n    }\n  }, {\n    key: \"auth\",\n    get: function get() {\n      return this.wallet ? this.wallet.auth : undefined;\n    }\n  }, {\n    key: \"api\",\n    get: function get() {\n      if (this.wallet) return this.wallet.eosApi;\n      if (this._api) return this._api;\n      var net = DEFAULT_EOS_NETWORK;\n      var rpc = new JsonRpc(\"\".concat(net.protocol, \"://\").concat(net.host, \":\").concat(net.port), {\n        fetch: fetch\n      });\n      var signatureProvider = new JsSignatureProvider([]);\n      var api = new Api({\n        rpc: rpc,\n        signatureProvider: signatureProvider,\n        chainId: net.chainId,\n        textDecoder: new TextDecoder(),\n        textEncoder: new TextEncoder()\n      });\n      this._api = api;\n      return api;\n    }\n  }]);\n\n  function EOS() {\n    _classCallCheck(this, EOS);\n\n    this.accessContext = void 0;\n    this.wallet = void 0;\n    this.discoveryData = void 0;\n    this.tokens = void 0;\n    this._api = void 0;\n  }\n\n  _createClass(EOS, [{\n    key: \"init\",\n    value: function () {\n      var _init = _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee(network) {\n        var transit, scatter, lynx, tokenpocket, meetone;\n        return _regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                if (!process.browser) {\n                  _context.next = 17;\n                  break;\n                }\n\n                _context.next = 3;\n                return import('eos-transit');\n\n              case 3:\n                transit = _context.sent;\n                _context.next = 6;\n                return import('eos-transit-scatter-provider');\n\n              case 6:\n                scatter = _context.sent;\n                _context.next = 9;\n                return import('eos-transit-lynx-provider');\n\n              case 9:\n                lynx = _context.sent;\n                _context.next = 12;\n                return import('eos-transit-tokenpocket-provider');\n\n              case 12:\n                tokenpocket = _context.sent;\n                _context.next = 15;\n                return import('eos-transit-meetone-provider');\n\n              case 15:\n                meetone = _context.sent;\n                this.accessContext = transit.initAccessContext({\n                  appName: 'discussions',\n                  network: network,\n                  walletProviders: [lynx[\"default\"](), tokenpocket[\"default\"](), meetone[\"default\"](), scatter[\"default\"]()]\n                });\n\n              case 17:\n                _context.next = 19;\n                return getTokens();\n\n              case 19:\n                this.tokens = _context.sent;\n\n              case 20:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, this);\n      }));\n\n      function init(_x) {\n        return _init.apply(this, arguments);\n      }\n\n      return init;\n    }()\n  }, {\n    key: \"tryConnectWallet\",\n    value: function () {\n      var _tryConnectWallet = _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee2(selectedProvider) {\n        var wallet, discoveryData;\n        return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                if (this.accessContext) {\n                  _context2.next = 2;\n                  break;\n                }\n\n                return _context2.abrupt(\"return\");\n\n              case 2:\n                wallet = this.accessContext.initWallet(selectedProvider);\n                _context2.next = 5;\n                return wallet.connect();\n\n              case 5:\n                if (!this.wallet) {\n                  _context2.next = 9;\n                  break;\n                }\n\n                throw new Error('Already have a wallet present');\n\n              case 9:\n                if (wallet.connected) {\n                  _context2.next = 11;\n                  break;\n                }\n\n                throw new Error('Failed to connect');\n\n              case 11:\n                _context2.next = 13;\n                return wallet.discover({\n                  pathIndexList: [0]\n                });\n\n              case 13:\n                discoveryData = _context2.sent;\n                // TO-DO: ledger\n                this.wallet = wallet;\n                this.discoveryData = discoveryData;\n                console.log('Detected and connected to ' + selectedProvider.meta.name);\n\n                if (discoveryData.keyToAccountMap.length > 0) {\n                  console.log(discoveryData);\n                }\n\n              case 18:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2, this);\n      }));\n\n      function tryConnectWallet(_x2) {\n        return _tryConnectWallet.apply(this, arguments);\n      }\n\n      return tryConnectWallet;\n    }()\n  }, {\n    key: \"detectWallet\",\n    value: function () {\n      var _detectWallet = _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee4() {\n        var _this = this;\n\n        var attempts,\n            providers,\n            i,\n            provider,\n            promises,\n            _args4 = arguments;\n        return _regeneratorRuntime.wrap(function _callee4$(_context4) {\n          while (1) {\n            switch (_context4.prev = _context4.next) {\n              case 0:\n                attempts = _args4.length > 0 && _args4[0] !== undefined ? _args4[0] : 1;\n\n                if (this.accessContext) {\n                  _context4.next = 3;\n                  break;\n                }\n\n                return _context4.abrupt(\"return\", false);\n\n              case 3:\n                providers = this.accessContext.getWalletProviders();\n                i = 0;\n\n              case 5:\n                if (!(i < attempts && !this.wallet)) {\n                  _context4.next = 26;\n                  break;\n                }\n\n                console.log('Wallet detection round ' + i);\n\n                if (!navigator.userAgent.toLowerCase().includes('meet.one')) {\n                  _context4.next = 20;\n                  break;\n                }\n\n                provider = providers.find(function (p) {\n                  return p.id == 'meetone_provider';\n                });\n\n                if (!provider) {\n                  _context4.next = 18;\n                  break;\n                }\n\n                _context4.prev = 10;\n                _context4.next = 13;\n                return this.tryConnectWallet(provider);\n\n              case 13:\n                _context4.next = 18;\n                break;\n\n              case 15:\n                _context4.prev = 15;\n                _context4.t0 = _context4[\"catch\"](10);\n                console.log('Undetected ' + provider.id);\n\n              case 18:\n                _context4.next = 23;\n                break;\n\n              case 20:\n                promises = providers.map(function (p) {\n                  return new Promise(\n                  /*#__PURE__*/\n                  function () {\n                    var _ref = _asyncToGenerator(\n                    /*#__PURE__*/\n                    _regeneratorRuntime.mark(function _callee3(resolve) {\n                      return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n                        while (1) {\n                          switch (_context3.prev = _context3.next) {\n                            case 0:\n                              _context3.prev = 0;\n                              _context3.next = 3;\n                              return _this.tryConnectWallet(p);\n\n                            case 3:\n                              _context3.next = 8;\n                              break;\n\n                            case 5:\n                              _context3.prev = 5;\n                              _context3.t0 = _context3[\"catch\"](0);\n                              console.log('Undetected ' + p.id);\n\n                            case 8:\n                              return _context3.abrupt(\"return\", resolve());\n\n                            case 9:\n                            case \"end\":\n                              return _context3.stop();\n                          }\n                        }\n                      }, _callee3, null, [[0, 5]]);\n                    }));\n\n                    return function (_x3) {\n                      return _ref.apply(this, arguments);\n                    };\n                  }());\n                });\n                _context4.next = 23;\n                return Promise.all(promises);\n\n              case 23:\n                i++;\n                _context4.next = 5;\n                break;\n\n              case 26:\n                return _context4.abrupt(\"return\", this.wallet);\n\n              case 27:\n              case \"end\":\n                return _context4.stop();\n            }\n          }\n        }, _callee4, this, [[10, 15]]);\n      }));\n\n      function detectWallet() {\n        return _detectWallet.apply(this, arguments);\n      }\n\n      return detectWallet;\n    }()\n  }, {\n    key: \"transact\",\n    value: function () {\n      var _transact = _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee5(actions) {\n        var auth, transitActions, tx;\n        return _regeneratorRuntime.wrap(function _callee5$(_context5) {\n          while (1) {\n            switch (_context5.prev = _context5.next) {\n              case 0:\n                if (this.wallet) {\n                  _context5.next = 2;\n                  break;\n                }\n\n                return _context5.abrupt(\"return\", undefined);\n\n              case 2:\n                auth = this.auth;\n\n                if (auth) {\n                  _context5.next = 5;\n                  break;\n                }\n\n                return _context5.abrupt(\"return\", undefined);\n\n              case 5:\n                if (!Array.isArray(actions)) {\n                  actions = [actions]; // single action\n                }\n\n                transitActions = actions.map(function (a) {\n                  return _objectSpread({}, a, {\n                    authorization: [{\n                      actor: auth.accountName,\n                      permission: auth.permission\n                    }]\n                  });\n                });\n                _context5.prev = 7;\n                _context5.next = 10;\n                return this.wallet.eosApi.transact({\n                  actions: transitActions\n                }, {\n                  broadcast: true,\n                  blocksBehind: 3,\n                  expireSeconds: 180\n                });\n\n              case 10:\n                tx = _context5.sent;\n                return _context5.abrupt(\"return\", tx ? tx.transaction_id : undefined);\n\n              case 14:\n                _context5.prev = 14;\n                _context5.t0 = _context5[\"catch\"](7);\n                console.error(_context5.t0);\n                throw _context5.t0;\n\n              case 18:\n              case \"end\":\n                return _context5.stop();\n            }\n          }\n        }, _callee5, this, [[7, 14]]);\n      }));\n\n      function transact(_x4) {\n        return _transact.apply(this, arguments);\n      }\n\n      return transact;\n    }()\n  }, {\n    key: \"getTransaction\",\n    value: function () {\n      var _getTransaction = _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee6(txid) {\n        var eos, tx;\n        return _regeneratorRuntime.wrap(function _callee6$(_context6) {\n          while (1) {\n            switch (_context6.prev = _context6.next) {\n              case 0:\n                if (this.wallet) {\n                  _context6.next = 2;\n                  break;\n                }\n\n                return _context6.abrupt(\"return\", undefined);\n\n              case 2:\n                eos = this.wallet.eosApi;\n                _context6.next = 5;\n                return eos.rpc.history_get_transaction(txid);\n\n              case 5:\n                tx = _context6.sent;\n                return _context6.abrupt(\"return\", tx);\n\n              case 7:\n              case \"end\":\n                return _context6.stop();\n            }\n          }\n        }, _callee6, this);\n      }));\n\n      function getTransaction(_x5) {\n        return _getTransaction.apply(this, arguments);\n      }\n\n      return getTransaction;\n    }()\n  }, {\n    key: \"getToken\",\n    value: function () {\n      var _getToken = _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee7(account, symbol) {\n        return _regeneratorRuntime.wrap(function _callee7$(_context7) {\n          while (1) {\n            switch (_context7.prev = _context7.next) {\n              case 0:\n                if (this.tokens) {\n                  _context7.next = 2;\n                  break;\n                }\n\n                return _context7.abrupt(\"return\", undefined);\n\n              case 2:\n                return _context7.abrupt(\"return\", this.tokens.find(function (t) {\n                  return t.account == account && t.symbol == symbol;\n                }));\n\n              case 3:\n              case \"end\":\n                return _context7.stop();\n            }\n          }\n        }, _callee7, this);\n      }));\n\n      function getToken(_x6, _x7) {\n        return _getToken.apply(this, arguments);\n      }\n\n      return getToken;\n    }()\n    /**\r\n     * Fetch a list of suggested users for mentions.\r\n     * @param accountPartial {string} - The partial name of the account\r\n     * @param limit \r\n     * @returns {string[]}\r\n     */\n\n  }, {\n    key: \"getSuggestAccounts\",\n    value: function () {\n      var _getSuggestAccounts = _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee8(accountPartial) {\n        var _limit,\n            request,\n            json,\n            _args8 = arguments;\n\n        return _regeneratorRuntime.wrap(function _callee8$(_context8) {\n          while (1) {\n            switch (_context8.prev = _context8.next) {\n              case 0:\n                _limit = _args8.length > 1 && _args8[1] !== undefined ? _args8[1] : 10;\n                _context8.next = 3;\n                return fetch(\"https://eos.greymass.com/v1/chain/get_table_by_scope\", {\n                  method: 'POST',\n                  body: JSON.stringify({\n                    \"code\": \"eosio\",\n                    \"table\": \"userres\",\n                    \"lower_bound\": accountPartial,\n                    \"upper_bound\": accountPartial.padEnd(12, 'z'),\n                    \"limit\": 5\n                  })\n                });\n\n              case 3:\n                request = _context8.sent;\n                _context8.next = 6;\n                return request.json();\n\n              case 6:\n                json = _context8.sent;\n                return _context8.abrupt(\"return\", json.rows.map(function (d) {\n                  return d.scope;\n                }));\n\n              case 8:\n              case \"end\":\n                return _context8.stop();\n            }\n          }\n        }, _callee8);\n      }));\n\n      function getSuggestAccounts(_x8) {\n        return _getSuggestAccounts.apply(this, arguments);\n      }\n\n      return getSuggestAccounts;\n    }()\n    /**\r\n     * Returns non-zero balances for a given username.\r\n     * @param account {string} - The name of the account (username)\r\n     * @returns {IAccountBalance[]}\r\n     */\n\n  }, {\n    key: \"getAccountTokens\",\n    value: function () {\n      var _getAccountTokens2 = _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee9(account) {\n        return _regeneratorRuntime.wrap(function _callee9$(_context9) {\n          while (1) {\n            switch (_context9.prev = _context9.next) {\n              case 0:\n                if (this.tokens) {\n                  _context9.next = 2;\n                  break;\n                }\n\n                return _context9.abrupt(\"return\", []);\n\n              case 2:\n                return _context9.abrupt(\"return\", _getAccountTokens(account, this.tokens));\n\n              case 3:\n              case \"end\":\n                return _context9.stop();\n            }\n          }\n        }, _callee9, this);\n      }));\n\n      function getAccountTokens(_x9) {\n        return _getAccountTokens2.apply(this, arguments);\n      }\n\n      return getAccountTokens;\n    }()\n  }, {\n    key: \"login\",\n    value: function () {\n      var _login = _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee10(account, permission) {\n        return _regeneratorRuntime.wrap(function _callee10$(_context10) {\n          while (1) {\n            switch (_context10.prev = _context10.next) {\n              case 0:\n                if (this.wallet) {\n                  _context10.next = 2;\n                  break;\n                }\n\n                return _context10.abrupt(\"return\", false);\n\n              case 2:\n                _context10.next = 4;\n                return this.wallet.login(account, permission);\n\n              case 4:\n                if (!this.auth) {\n                  _context10.next = 7;\n                  break;\n                }\n\n                window.dispatchEvent(new Event('eosAccountChange'));\n                return _context10.abrupt(\"return\", true);\n\n              case 7:\n                return _context10.abrupt(\"return\", false);\n\n              case 8:\n              case \"end\":\n                return _context10.stop();\n            }\n          }\n        }, _callee10, this);\n      }));\n\n      function login(_x10, _x11) {\n        return _login.apply(this, arguments);\n      }\n\n      return login;\n    }()\n  }, {\n    key: \"logout\",\n    value: function () {\n      var _logout = _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee11() {\n        return _regeneratorRuntime.wrap(function _callee11$(_context11) {\n          while (1) {\n            switch (_context11.prev = _context11.next) {\n              case 0:\n                if (this.wallet) {\n                  _context11.next = 2;\n                  break;\n                }\n\n                return _context11.abrupt(\"return\");\n\n              case 2:\n                _context11.next = 4;\n                return this.wallet.logout();\n\n              case 4:\n                if (!this.auth) {\n                  window.dispatchEvent(new Event('eosAccountChange'));\n                }\n\n              case 5:\n              case \"end\":\n                return _context11.stop();\n            }\n          }\n        }, _callee11, this);\n      }));\n\n      function logout() {\n        return _logout.apply(this, arguments);\n      }\n\n      return logout;\n    }()\n  }]);\n\n  return EOS;\n}();","map":null,"metadata":{},"sourceType":"module"}